<UserControl x:Class="Veriflow.Desktop.Views.PlayerView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:local="clr-namespace:Veriflow.Desktop.Views"
             xmlns:vm="clr-namespace:Veriflow.Desktop.ViewModels"
             mc:Ignorable="d" 
             d:DesignHeight="450" d:DesignWidth="800"
             AllowDrop="True"
             Background="Transparent">
    
    <!-- Keyboard shortcuts now handled at MainWindow level for persistence -->
    
    <!-- Keyboard shortcuts now handled at MainWindow level for persistence -->

    <UserControl.Resources>
        <BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>
        
        <!-- ========================================================================= -->
        <!-- Transport styles now in Theme.Pro.xaml                                    -->
        <!-- ========================================================================= -->

        <!-- ========================================================================= -->
        <!-- Slider styles now in Theme.Pro.xaml                                      -->
        <!-- ========================================================================= -->

        <!-- ========================================================================= -->
        <!-- 1. IMPLICIT TEMPLATES (Main Player Views)                                 -->
        <!-- ========================================================================= -->
        <DataTemplate DataType="{x:Type vm:VideoPlayerViewModel}">
            <local:VideoPlayerView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:AudioPlayerViewModel}">
            <local:AudioPlayerView/>
        </DataTemplate>
        <DataTemplate DataType="{x:Type vm:PlayerViewModel}">
            <local:AudioPlayerView/>
        </DataTemplate>

        <!-- ========================================================================= -->
        <!-- 2. EXPLICIT TEMPLATES (Metadata Panels)                                   -->
        <!-- ========================================================================= -->
        <DataTemplate x:Key="VideoMetaTemplate">
            <local:VideoMetadataView/>
        </DataTemplate>
         <DataTemplate x:Key="AudioMetaTemplate">
            <local:AudioMetadataView/>
        </DataTemplate>

    </UserControl.Resources>

    <Grid>
        
        <Grid.ColumnDefinitions>
            <!-- COL 0: Player + Transport (Takes remaining space) -->
            <ColumnDefinition Width="2*"/>
            <!-- COL 1: Metadata (Fixed Width, Full Height) -->
            <ColumnDefinition Width="350"/>
        </Grid.ColumnDefinitions>

        <!-- LEFT COLUMN: Player & Controls -->
        <Grid Grid.Column="0">
            <Grid.RowDefinitions>
                <RowDefinition Height="*"/>    <!-- Player Content -->
                <RowDefinition Height="Auto"/> <!-- Transport Controls -->
            </Grid.RowDefinitions>

            <!-- Player View (Implicit Template) -->
            <ContentControl Grid.Row="0" Content="{Binding}"/>

            <!-- Drag & Drop Hint (Moved below ContentControl for Z-Order) -->
            <TextBlock Grid.Row="0"
                       VerticalAlignment="Center" HorizontalAlignment="Center"
                       Foreground="#555" FontSize="18" FontWeight="Bold"
                       IsHitTestVisible="False"
                       Panel.ZIndex="100">
                <TextBlock.Style>
                    <Style TargetType="TextBlock">
                        <Setter Property="Text" Value="DROP VIDEO MEDIA FILE HERE"/>
                        <Setter Property="Visibility" Value="Collapsed"/>
                        <Style.Triggers>
                            <!-- Visibility Trigger (Common to both VMs) -->
                            <DataTrigger Binding="{Binding HasMedia}" Value="False">
                                <Setter Property="Visibility" Value="Visible"/>
                            </DataTrigger>
                            <!-- Text Logic -->
                            <DataTrigger Binding="{Binding ShowVolumeControls}" Value="False">
                                <Setter Property="Text" Value="DROP AUDIO MEDIA FILE HERE"/>
                            </DataTrigger>
                        </Style.Triggers>
                    </Style>
                </TextBlock.Style>
            </TextBlock>

            <!-- Transport Controls (Centered relative to Player) -->
            <Border Grid.Row="1" Background="Transparent" Padding="5">
                <Grid>
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="*"/>    <!-- Left Spacer -->
                        <ColumnDefinition Width="Auto"/> <!-- Center (Play) -->
                        <ColumnDefinition Width="*"/>    <!-- Right Spacer -->
                    </Grid.ColumnDefinitions>

                    <!-- Stop Button (Right-aligned in Left box) -->
                    <StackPanel Grid.Column="0" Orientation="Horizontal" HorizontalAlignment="Right" VerticalAlignment="Center" Margin="0,0,15,0">
                        <Button Command="{Binding StopCommand}" Tag="{Binding IsStopPressed}" ToolTip="Stop" Style="{StaticResource Style.Transport.Stop}">
                            <Path Data="M6,6H18V18H6V6Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" Height="14" Width="14" Stretch="Uniform"/>
                        </Button>
                    </StackPanel>

                    <!-- Play Button (Centered in Middle box) -->
                    <Button Grid.Column="1" Command="{Binding PlayCommand}" Tag="{Binding IsPlaying}" ToolTip="Play" Style="{StaticResource Style.Transport.Play}" HorizontalAlignment="Center" VerticalAlignment="Center">
                        <Path Data="M8,5.14V19.14L19,12.14L8,5.14Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" Height="20" Width="20" Stretch="Uniform" Margin="2,0,0,0"/>
                    </Button>

                    <!-- Pause & Volume (Left-aligned in Right box) -->
                    <StackPanel Grid.Column="2" Orientation="Horizontal" HorizontalAlignment="Left" VerticalAlignment="Center" Margin="15,0,0,0">
                         <Button Command="{Binding PauseCommand}" Tag="{Binding IsPaused}" ToolTip="Pause" Style="{StaticResource Style.Transport.Pause}" Margin="0,0,20,0">
                            <Path Data="M14,19H18V5H14M6,19H10V5H6V19Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" Height="14" Width="14" Stretch="Uniform"/>
                        </Button>

                         <!-- Volume Group -->
                         <StackPanel Orientation="Horizontal" VerticalAlignment="Center"
                                     Visibility="{Binding ShowVolumeControls, Converter={StaticResource BooleanToVisibilityConverter}}">
                              <Button Command="{Binding ToggleMuteCommand}" Focusable="False" ToolTip="Mute/Unmute" Background="Transparent" BorderThickness="0" Margin="0,0,10,0">
                                  <Button.Template>
                                      <ControlTemplate TargetType="Button">
                                          <Grid>
                                              <Path x:Name="Icon" Data="M14,3.23V5.29C16.89,6.15 19,8.83 19,12C19,15.17 16.89,17.84 14,18.7V20.77C18,19.86 21,16.28 21,12C21,7.72 18,4.14 14,3.23M16.5,12C16.5,10.23 15.5,8.71 14,7.97V16C15.5,15.29 16.5,13.76 16.5,12M3,9V15H7L12,20V4L7,9H3Z" Fill="{Binding Foreground, RelativeSource={RelativeSource AncestorType=Button}}" Height="16" Width="16" Stretch="Uniform"/>
                                          </Grid>
                                          <ControlTemplate.Triggers>
                                              <Trigger Property="IsMouseOver" Value="True"><Setter Property="Foreground" Value="White"/></Trigger>
                                              <Trigger Property="IsMouseOver" Value="False"><Setter Property="Foreground" Value="{DynamicResource Brush.Text.Secondary}"/></Trigger>
                                              <DataTrigger Binding="{Binding IsMuted}" Value="True">
                                                  <Setter TargetName="Icon" Property="Data" Value="M12,4L9.91,6.09L12,8.18M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12Z"/>
                                                  <Setter Property="Foreground" Value="{DynamicResource Brush.State.Mute}"/>
                                              </DataTrigger>
                                          </ControlTemplate.Triggers>
                                      </ControlTemplate>
                                  </Button.Template>
                              </Button>
                              <Slider Value="{Binding Volume}" Maximum="1" Minimum="0" Width="100" Focusable="False" Style="{StaticResource RoundFilledSliderStyle}"
                                      PreviewMouseLeftButtonDown="Slider_PreviewMouseLeftButtonDown"
                                      PreviewMouseMove="Slider_PreviewMouseMove"
                                      PreviewMouseLeftButtonUp="Slider_PreviewMouseLeftButtonUp"/>
                         </StackPanel>
                    </StackPanel>
                </Grid>
            </Border>
        </Grid>

        <!-- RIGHT COLUMN: Metadata Panel -->
        <ContentControl Grid.Column="1" Content="{Binding}">
            <ContentControl.Style>
                <Style TargetType="ContentControl">
                    <!-- Default to Audio Metadata -->
                    <Setter Property="ContentTemplate" Value="{StaticResource AudioMetaTemplate}"/>
                    <Style.Triggers>
                        <!-- Switch to Video Metadata if ShowVolumeControls is True (Video VM) -->
                        <DataTrigger Binding="{Binding ShowVolumeControls}" Value="True">
                            <Setter Property="ContentTemplate" Value="{StaticResource VideoMetaTemplate}"/>
                        </DataTrigger>
                    </Style.Triggers>
                </Style>
            </ContentControl.Style>
        </ContentControl>
        
    </Grid>
</UserControl>
